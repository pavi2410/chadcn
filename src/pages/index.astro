---
import MainLayout from '@/layouts/MainLayout.astro';
import RegistryCard from '@/components/registry/RegistryCard';
import { getCollection } from 'astro:content';
import { fetchRegistryData, processRegistryData } from '@/lib/registry';

// Get all registry URLs from our collection
const registryEntries = await getCollection('registries');

// Fetch data for each registry
const registriesData = await Promise.all(
  registryEntries.map(async (entry) => {
    const rawData = await fetchRegistryData(entry.data.url);
    if (!rawData) return null;
    
    return {
      id: entry.id,
      url: entry.data.url,
      featured: entry.data.featured,
      addedAt: entry.data.addedAt,
      ...processRegistryData(rawData)
    };
  })
);

// Filter out any failed fetches and sort by featured status
const validRegistries = registriesData
  .filter((registry): registry is NonNullable<typeof registry> => registry !== null)
  .sort((a, b) => {
    if (a.featured && !b.featured) return -1;
    if (!a.featured && b.featured) return 1;
    return 0;
  });

const featuredRegistries = validRegistries.filter(registry => registry.featured);
---

<MainLayout title="shadcn Registry Directory">
  <section class="py-12">
    <div class="container">
      <div class="max-w-3xl space-y-4 mb-12">
        <h1 class="text-4xl font-bold">shadcn Registry Directory</h1>
        <p class="text-lg text-muted-foreground">Discover and explore shadcn UI component registries created by the community.</p>
      </div>
      
      <!-- Featured Registries -->
      {featuredRegistries.length > 0 && (
        <div class="mb-16">
          <h2 class="text-2xl font-bold mb-6">Featured Registries</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {featuredRegistries.map(registry => (
              <RegistryCard 
                client:load
                registry={registry} 
                href={`/registry/${registry.id}`}
              />
            ))}
          </div>
        </div>
      )}
      
      <!-- All Registries -->
      <h2 class="text-2xl font-bold mb-6">All Registries</h2>
      {validRegistries.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {validRegistries.map(registry => (
            <RegistryCard 
              client:load
              registry={registry} 
              href={`/registry/${registry.id}`}
            />
          ))}
        </div>
      ) : (
        <div class="py-12 text-center">
          <p class="text-muted-foreground">No valid registries found. Please check the registry URLs and try again.</p>
        </div>
      )}
    </div>
  </section>
</MainLayout>
